// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --------------------------------------
// User & Role
// --------------------------------------

model Role {
  id          String   @id @default(uuid()) @map("roleId")
  name        String // "ADMIN", "STAFF", "CUSTOMER", "GUEST"
  description String?
  permissions String[] // Stored as array of strings

  users User[]

  @@map("roles")
}

model User {
  id           String   @id @default(uuid()) @map("userId")
  roleId       String
  fullName     String
  email        String   @unique
  passwordHash String?
  status       String   @default("ACTIVE")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  role      Role      @relation(fields: [roleId], references: [id])
  addresses Address[]
  orders    Order[]   @relation("UserOrders") // Orders placed by this user
  cart      Cart? // One-to-one (optional)

  // Relations for "written by"
  staffNotes StaffNote[] @relation("NoteAuthor")

  // Audit relations (created by/confirmed by etc)
  ordersCreated   Order[] @relation("OrderCreator")
  ordersConfirmed Order[] @relation("OrderConfirmer")
  ordersCompleted Order[] @relation("OrderCompleter")
  ordersCancelled Order[] @relation("OrderCanceller")

  inventoryTxCreated InventoryTx[] @relation("TxCreator")

  @@map("users")
}

// --------------------------------------
// Address
// --------------------------------------

model Address {
  id            String   @id @default(uuid()) @map("addressId")
  userId        String
  recipientName String
  line1         String
  ward          String
  district      String
  province      String
  phoneNumber   String
  isDefault     Boolean  @default(false)
  createdAt     DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("addresses")
}

// --------------------------------------
// Product & Variant
// --------------------------------------

model Product {
  id          String   @id @default(uuid()) @map("productId")
  name        String
  brand       String
  description String?  @db.Text
  status      String
  imageUrl    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  variants Variant[]

  @@map("products")
}

model Variant {
  id            String   @id @default(uuid()) @map("variantId")
  productId     String
  name          String
  color         String
  capacity      String
  price         Decimal  @db.Decimal(10, 2)
  stockQuantity Int      @default(0)
  status        String
  imageUrl      String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  product      Product       @relation(fields: [productId], references: [id], onDelete: Cascade)
  cartItems    CartItem[]
  orderItems   OrderItem[]
  inventoryTxs InventoryTx[]

  @@map("variants")
}

// --------------------------------------
// Cart
// --------------------------------------

model Cart {
  id          String   @id @default(uuid()) @map("cartId")
  userId      String?  @unique
  totalItems  Int      @default(0)
  totalAmount Decimal  @default(0) @db.Decimal(10, 2)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user      User?      @relation(fields: [userId], references: [id])
  cartItems CartItem[]

  @@map("carts")
}

model CartItem {
  id         String  @id @default(uuid()) @map("cartItemId")
  cartId     String
  variantId  String
  qty        Int     @default(1)
  unitPrice  Decimal @db.Decimal(10, 2)
  lineAmount Decimal @db.Decimal(10, 2)

  // Relations
  cart    Cart    @relation(fields: [cartId], references: [id], onDelete: Cascade)
  variant Variant @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@map("cart_items")
}

// --------------------------------------
// Order
// --------------------------------------

model Order {
  id              String  @id @default(uuid()) @map("orderId")
  userId          String
  paymentMethod   String
  status          String
  subtotal        Decimal @db.Decimal(10, 2)
  shippingFee     Decimal @db.Decimal(10, 2)
  totalAmount     Decimal @db.Decimal(10, 2)
  shippingAddress Json    @db.Json

  createdAt    DateTime  @default(now())
  confirmedAt  DateTime?
  completedAt  DateTime?
  cancelledAt  DateTime?
  cancelReason String?

  // Audit Fields
  createdBy   String?
  confirmedBy String?
  completedBy String?
  cancelledBy String?

  // Relations
  user User @relation("UserOrders", fields: [userId], references: [id])

  // Management relations
  createdByUser   User? @relation("OrderCreator", fields: [createdBy], references: [id])
  confirmedByUser User? @relation("OrderConfirmer", fields: [confirmedBy], references: [id])
  completedByUser User? @relation("OrderCompleter", fields: [completedBy], references: [id])
  cancelledByUser User? @relation("OrderCanceller", fields: [cancelledBy], references: [id])

  items      OrderItem[]
  staffNotes StaffNote[]

  @@map("orders")
}

model OrderItem {
  id                  String  @id @default(uuid()) @map("orderItemId")
  orderId             String
  variantId           String
  variantNameSnapshot String
  unitPrice           Decimal @db.Decimal(10, 2)
  quantity            Int
  lineTotal           Decimal @db.Decimal(10, 2)

  // Relations
  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  variant Variant @relation(fields: [variantId], references: [id])

  @@map("order_items")
}

// --------------------------------------
// StaffNote & InventoryTx
// --------------------------------------

model StaffNote {
  id        String   @id @default(uuid()) @map("noteId")
  orderId   String
  staffId   String
  content   String   @db.Text
  createdAt DateTime @default(now())

  // Relations
  order  Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  author User  @relation("NoteAuthor", fields: [staffId], references: [id])

  @@map("staff_notes")
}

model InventoryTx {
  id        String   @id @default(uuid()) @map("inventoryTxId")
  variantId String
  type      String
  quantity  Int
  reason    String
  createdBy String
  createdAt DateTime @default(now())

  // Relations
  variant Variant @relation(fields: [variantId], references: [id], onDelete: Cascade)
  creator User    @relation("TxCreator", fields: [createdBy], references: [id])

  @@map("inventory_transactions")
}
